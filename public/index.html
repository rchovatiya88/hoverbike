<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>A-Frame FPS Game Prototype</title>
        <!-- A-Frame and YUKA libraries -->
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/yuka@0.7.8/build/yuka.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
        <!-- Draco loader scripts -->
        <!-- Three.js must come before DRACOLoader -->
        <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/build/three.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/loaders/DRACOLoader.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/loaders/GLTFLoader.js"></script>
        <script src="js/draco-decoder.js"></script>
        <!-- Custom components -->
        <script src="components/utils.js"></script>
        <script src="components/hitbox-component.js"></script>
        <script src="components/player-component.js"></script>
        <script src="components/weapon-component.js"></script>
        <script src="components/enemy-component.js"></script>
        <script src="components/game-manager.js"></script>
        <script src="components/simple-navmesh-constraint.js"></script>
        <script src="components/model-camera-fix.js"></script>
        <script src="components/third-person-camera.js"></script>
        <script src="components/position-debug.js"></script>
        <script src="components/camera-test.js"></script>

        <style>
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            #crosshair {
                position: absolute;
                top: 50%;
                left: 50%;
                width: 20px;
                height: 20px;
                margin: -10px 0 0 -10px;
                color: white;
                font-size: 20px;
                text-align: center;
                line-height: 20px;
                pointer-events: none;
                z-index: 10;
            }

            #game-message {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 2em;
                text-align: center;
                background-color: rgba(0, 0, 0, 0.7);
                padding: 20px;
                border-radius: 10px;
                z-index: 1000;
                font-family: Arial, sans-serif;
                display: block;
            }

            #start-button {
                display: block;
                margin: 20px auto 0;
                padding: 10px 20px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 1em;
                cursor: pointer;
            }

            #start-button:hover {
                background-color: #45a049;
            }

            #health-display {
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: 200px;
                height: 20px;
                background-color: rgba(0, 0, 0, 0.5);
                border: 2px solid white;
                border-radius: 5px;
                z-index: 100;
                overflow: hidden;
                pointer-events: none;
            }

            #health-bar {
                width: 100%;
                height: 100%;
                background-color: #0f0;
                transition:
                    width 0.3s ease,
                    background-color 0.3s ease;
            }

            #ammo-display {
                position: absolute;
                bottom: 20px;
                right: 20px;
                color: white;
                background-color: rgba(0, 0, 0, 0.5);
                padding: 10px;
                border-radius: 5px;
                font-family: monospace;
                font-size: 1.5em;
                z-index: 100;
                pointer-events: none;
            }

            #score-ui {
                position: absolute;
                top: 20px;
                left: 20px;
                color: white;
                background-color: rgba(0, 0, 0, 0.5);
                padding: 10px;
                border-radius: 5px;
                font-family: Arial, sans-serif;
                z-index: 100;
                pointer-events: none;
            }

            #damage-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(255, 0, 0, 0);
                pointer-events: none;
                z-index: 100;
                transition: background-color 0.1s ease-in-out;
            }

            #player-ui {
                position: relative; /* Added to contain all UI elements */
            }

            #control-hints {
                position: absolute;
                bottom: 20px;
                right: 20px;
                background: rgba(0,0,0,0.5);
                color: #fff;
                padding: 10px;
                border-radius: 5px;
                font-size: 14px;
            }

            #control-hints h3 {
                margin: 0 0 5px 0;
            }

            #control-hints ul {
                margin: 0;
                padding-left: 20px;
            }

        </style>
    </head>

    <body>
        <!-- UI Elements -->
        <div id="crosshair">+</div>
        <div id="player-ui">
            <div id="health-display">
                <div id="health-bar"></div>
            </div>
            <div id="ammo-display">30 / âˆž</div>
            <div id="control-hints" style="position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.5); color: #fff; padding: 10px; border-radius: 5px; font-size: 14px;">
                <h3 style="margin: 0 0 5px 0">Jetbike Controls</h3>
                <ul style="margin: 0; padding-left: 20px">
                    <li>W/S: Forward/Back</li>
                    <li>A/D: Left/Right</li>
                    <li>Q/E: Up/Down</li>
                    <li>Shift: Boost</li>
                    <li>Mouse: Aim</li>
                </ul>
            </div>
        </div>
        <div id="score-ui">
            <div>Level: <span id="level-value">1</span></div>
            <div>Score: <span id="score-value">0</span></div>
            <div>Enemies: <span id="enemies-value">5</span></div>
        </div>
        <div id="damage-overlay"></div>
        <div id="game-message">
            Welcome to Hover Jetbike Shooter!<br />
            WASD to move, Q/E to ascend/descend, Mouse to aim, Click to shoot<br /><br />
            <button id="start-button">Start Game</button>
        </div>

        <a-scene
            game-manager="enemyCount: 5; level: 1; spawnRadius: 15"
            vr-mode-ui="enabled: false"
            renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true;"
            simple-navmesh-constraint="navmesh:.navmesh;fall:0.5;height:0;exclude:.navmesh-hole;"
            position-debug="player: #player; camera: #camera-rig"
            camera-test
        >
            <a-assets>
                <!-- Sound assets removed to fix encoding errors -->
                <a-asset-item
                    id="jetbike-model"
                    src="/models/hoverbikewithavi.glb"
                ></a-asset-item>
                <!-- Simple enemy model (box for now) -->
                <a-mixin

            <div id="debug-overlay" style="position: absolute; top: 60px; left: 20px; background-color: rgba(0,0,0,0.5); color: white; padding: 10px; border-radius: 5px; font-family: monospace; z-index: 100;">
                <div>Player Position: <span id="player-pos">N/A</span></div>
                <div>Player Rotation: <span id="player-rot">N/A</span></div>
                <div>Camera Rotation: <span id="camera-rot">N/A</span></div>
            </div>

                    id="enemy-mixin"
                    geometry="primitive: box; width: 1; height: 1; depth: 1"
                    material="color: red"
                    scale="0.5 0.5 0.5"
                ></a-mixin>
            </a-assets>
            <!-- Environment -->
            <a-plane
                ground
                position="0 0 0"
                rotation="-90 0 0"
                width="100"
                height="50"
                color="#7BC8A4"
            ></a-plane>

            <!-- Walls -->
            <!-- North Wall - Blue -->
            <a-entity position="0 15 -25">
                <a-box
                    width="100"
                    height="40"
                    depth="1"
                    color="#4287f5"
                    shadow="cast: true; receive: true"
                ></a-box>
                <a-text
                    value="NORTH WALL"
                    position="0 5 0.6"
                    rotation="0 0 0"
                    color="white"
                    align="center"
                    width="50"
                    scale="10 10 10"
                ></a-text>
            </a-entity>
            
            <!-- South Wall - Red -->
            <a-entity position="0 15 25">
                <a-box
                    width="100"
                    height="40"
                    depth="1"
                    color="#f54242"
                    shadow="cast: true; receive: true"
                ></a-box>
                <a-text
                    value="SOUTH WALL"
                    position="0 5 -0.6"
                    rotation="0 180 0"
                    color="white"
                    align="center"
                    width="50"
                    scale="10 10 10"
                ></a-text>
            </a-entity>
            
            <!-- East Wall - Green -->
            <a-entity position="50 15 0">
                <a-box
                    width="1"
                    height="40"
                    depth="50"
                    color="#42f563"
                    shadow="cast: true; receive: true"
                ></a-box>
                <a-text
                    value="EAST WALL"
                    position="-0.6 5 0"
                    rotation="0 -90 0"
                    color="white"
                    align="center"
                    width="25"
                    scale="10 10 10"
                ></a-text>
            </a-entity>
            
            <!-- West Wall - Yellow -->
            <a-entity position="-50 15 0">
                <a-box
                    width="1"
                    height="40"
                    depth="50"
                    color="#f5d442"
                    shadow="cast: true; receive: true"
                ></a-box>
                <a-text
                    value="WEST WALL"
                    position="0.6 5 0"
                    rotation="0 90 0"
                    color="white"
                    align="center"
                    width="25"
                    scale="10 10 10"
                ></a-text>
            </a-entity>

            <!-- Height markers on walls -->
            <a-entity position="0 0 -24.5">
                <!-- North wall height markers -->
                <a-text value="0m" position="-45 0 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
                <a-text value="5m" position="-45 5 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
                <a-text value="10m" position="-45 10 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
                <a-text value="15m" position="-45 15 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
                <a-text value="20m" position="-45 20 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
                <a-text value="25m" position="-45 25 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
                <a-text value="30m" position="-45 30 0" rotation="0 0 0" color="white" scale="5 5 5"></a-text>
            </a-entity>

            <!-- Player with third-person camera -->
            <a-entity
                id="player"
                gltf-model="#jetbike-model"
                player-component="speed: 5; health: 100"
                weapon-component="damage: 25; cooldown: 0.5; automatic: true"
                position="0 1.5 10"
                rotation="0 0 0"
            >
                <!-- Weapons attached to the bike -->
                <a-entity
                    id="weapon-mount-left"
                    position="-0.5 0 -0.2"
                    rotation="0 0 0"
                >
                </a-entity>
                <a-entity
                    id="weapon-mount-right"
                    position="0.5 0 -0.2"
                    rotation="0 0 0"
                >
                </a-entity>
                
                <!-- Direction indicators for debugging -->
                <a-entity id="forward-indicator" position="0 0 -3">
                    <a-box color="red" scale="0.2 0.2 3"></a-box>
                    <a-text value="FORWARD" position="0 0.5 -1.5" scale="2 2 2" align="center" color="red"></a-text>
                </a-entity>
            </a-entity>

            <!-- Third-person camera (pointing toward north wall) -->
            <a-entity
                id="camera-rig"
                third-person-camera="target: #player; distance: 12; height: 4.5; lookAtHeight: 1.5; damping: 0.3"
                position="0 0 0"
                rotation="0 0 0"
            >
                <a-camera
                    id="camera"
                    look-controls="reverseMouseDrag: false; touchEnabled: true; pointerLockEnabled: true; magicWindowTrackingEnabled: false"
                    wasd-controls="enabled: false"
                    position="0 0 0"
                    rotation="0 0 0"
                >
                </a-camera>
            </a-entity>
            <!-- Sky -->
            <a-sky color="#88CCEE"></a-sky>
            <!-- Lights -->
            <a-light type="ambient" color="#BBB" intensity="0.5"></a-light>
            <a-light
                type="directional"
                color="#FFF"
                intensity="1"
                position="-1 1 1"
            ></a-light>
        </a-scene>

        <script>
            document
                .getElementById("start-button")
                .addEventListener("click", function () {
                    document.getElementById("game-message").style.display =
                        "none";
                    document.body.requestPointerLock =
                        document.body.requestPointerLock ||
                        document.body.mozRequestPointerLock ||
                        document.body.webkitRequestPointerLock;
                    document.body.requestPointerLock();
                    const gameManager =
                        document.querySelector("[game-manager]").components[
                            "game-manager"
                        ];
                    if (gameManager && gameManager.startGame) {
                        gameManager.startGame();
                    }
                });

            document.addEventListener("pointerlockerror", function (event) {
                console.error("Pointer lock error:", event);
                const gameMessage = document.getElementById("game-message");
                gameMessage.style.display = "block";
                gameMessage.innerHTML =
                    'Error: Could not lock pointer. Please try again.<br><button id="retry-button">Retry</button>';
                document
                    .getElementById("retry-button")
                    .addEventListener("click", function () {
                        document.body.requestPointerLock();
                        gameMessage.style.display = "none";
                    });
            });

            document.addEventListener("pointerlockchange", function () {
                if (document.pointerLockElement === document.body) {
                    console.log("Pointer locked");
                } else {
                    console.log("Pointer unlocked");
                    const gameManager =
                        document.querySelector("[game-manager]");
                    const gameManagerComponent =
                        gameManager && gameManager.components
                            ? gameManager.components["game-manager"]
                            : null;

                    if (
                        gameManagerComponent &&
                        gameManagerComponent.gameStarted
                    ) {
                        const gameMessage =
                            document.getElementById("game-message");
                        gameMessage.style.display = "block";
                        gameMessage.innerHTML =
                            'Game Paused<br><button id="resume-button">Resume</button>';
                        document
                            .getElementById("resume-button")
                            .addEventListener(
                                "click",
                                function () {
                                    document.body.requestPointerLock();
                                    gameMessage.style.display = "none";
                                },
                                {
                                    once: true,
                                },
                            );
                    }
                }
            });
        </script>
    </body>
</html>