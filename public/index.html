<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>A-Frame FPS Game Prototype</title>
        <!-- A-Frame and YUKA libraries -->
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/yuka@0.7.8/build/yuka.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
        <!-- Draco loader scripts -->
        <!-- Three.js must come before DRACOLoader -->
        <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/build/three.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/loaders/DRACOLoader.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/loaders/GLTFLoader.js"></script>
        <script src="js/draco-decoder.js"></script>
        <!-- Custom components -->
        <script src="components/utils.js"></script>
        <script src="components/hitbox-component.js"></script>
        <script src="components/player-component.js"></script>
        <script src="components/weapon-component.js"></script>
        <script src="components/enemy-component.js"></script>
        <script src="components/game-manager.js"></script>
        <script src="components/simple-navmesh-constraint.js"></script>
        <script src="components/model-camera-fix.js"></script>
        <script src="components/third-person-camera.js"></script>

        <style>
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            #crosshair {
                position: absolute;
                top: 50%;
                left: 50%;
                width: 20px;
                height: 20px;
                margin: -10px 0 0 -10px;
                color: white;
                font-size: 20px;
                text-align: center;
                line-height: 20px;
                pointer-events: none;
                z-index: 10;
            }

            #game-message {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 2em;
                text-align: center;
                background-color: rgba(0, 0, 0, 0.7);
                padding: 20px;
                border-radius: 10px;
                z-index: 1000;
                font-family: Arial, sans-serif;
                display: block;
            }

            #start-button {
                display: block;
                margin: 20px auto 0;
                padding: 10px 20px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 1em;
                cursor: pointer;
            }

            #start-button:hover {
                background-color: #45a049;
            }

            #health-display {
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: 200px;
                height: 20px;
                background-color: rgba(0, 0, 0, 0.5);
                border: 2px solid white;
                border-radius: 5px;
                z-index: 100;
                overflow: hidden;
                pointer-events: none;
            }

            #health-bar {
                width: 100%;
                height: 100%;
                background-color: #0f0;
                transition:
                    width 0.3s ease,
                    background-color 0.3s ease;
            }

            #ammo-display {
                position: absolute;
                bottom: 20px;
                right: 20px;
                color: white;
                background-color: rgba(0, 0, 0, 0.5);
                padding: 10px;
                border-radius: 5px;
                font-family: monospace;
                font-size: 1.5em;
                z-index: 100;
                pointer-events: none;
            }

            #score-ui {
                position: absolute;
                top: 20px;
                left: 20px;
                color: white;
                background-color: rgba(0, 0, 0, 0.5);
                padding: 10px;
                border-radius: 5px;
                font-family: Arial, sans-serif;
                z-index: 100;
                pointer-events: none;
            }

            #damage-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(255, 0, 0, 0);
                pointer-events: none;
                z-index: 100;
                transition: background-color 0.1s ease-in-out;
            }
        </style>
    </head>

    <body>
        <!-- UI Elements -->
        <div id="crosshair">+</div>
        <div id="health-display">
            <div id="health-bar"></div>
        </div>
        <div id="ammo-display">30 / âˆž</div>
        <div id="score-ui">
            <div>Level: <span id="level-value">1</span></div>
            <div>Score: <span id="score-value">0</span></div>
            <div>Enemies: <span id="enemies-value">5</span></div>
        </div>
        <div id="damage-overlay"></div>
        <div id="game-message">
            Welcome to Hover Jetbike Shooter!<br />
            WASD to move, Q/E to ascend/descend, Mouse to aim, Click to shoot<br />
            Press D to toggle debug mode, Arrow keys to adjust camera in debug mode<br /><br />
            <button id="start-button">Start Game</button>
        </div>
        
        <div id="camera-debug-controls" style="display: none; position: absolute; right: 20px; top: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; color: white; z-index: 100;">
            <div>Camera Adjustments</div>
            <div>
                <label>Height: <span id="camera-height-value">4.5</span></label>
                <input type="range" id="camera-height" min="0" max="10" step="0.5" value="4.5">
            </div>
            <div>
                <label>Distance: <span id="camera-distance-value">8</span></label>
                <input type="range" id="camera-distance" min="1" max="15" step="0.5" value="8">
            </div>
            <div>
                <label>Look Height: <span id="camera-look-height-value">1.5</span></label>
                <input type="range" id="camera-look-height" min="0" max="5" step="0.5" value="1.5">
            </div>
            <div>
                <button id="toggle-debug-viz">Toggle Debug Visualization</button>
            </div>
        </div>

        <a-scene
            game-manager="enemyCount: 5; level: 1; spawnRadius: 15"
            vr-mode-ui="enabled: false"
            renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true;"
            simple-navmesh-constraint="navmesh:.navmesh;fall:0.5;height:0;exclude:.navmesh-hole;"
        >
            <a-assets>
                <!-- Sound assets removed to fix encoding errors -->
                <a-asset-item
                    id="jetbike-model"
                    src="/models/hoverbikewithavi.glb"
                ></a-asset-item>
                <!-- Simple enemy model (box for now) -->
                <a-mixin
                    id="enemy-mixin"
                    geometry="primitive: box; width: 1; height: 1; depth: 1"
                    material="color: red"
                    scale="0.5 0.5 0.5"
                ></a-mixin>
            </a-assets>
            <!-- Environment -->
            <a-plane
                ground
                position="0 0 0"
                rotation="-90 0 0"
                width="50"
                height="50"
                color="#7BC8A4"
            ></a-plane>

            <!-- Player with third-person camera -->
            <a-entity
                id="player"
                gltf-model="#jetbike-model"
                player-component="speed: 5; health: 100"
                weapon-component="damage: 25; cooldown: 0.5; automatic: true"
                position="0 2 0"
                rotation="0 180 0"
            >
                <!-- Weapons attached to the bike -->
                <a-entity
                    id="weapon-mount-left"
                    position="-0.5 0 -0.2"
                    rotation="0 0 0"
                >
                </a-entity>
                <a-entity
                    id="weapon-mount-right"
                    position="0.5 0 -0.2"
                    rotation="0 0 0"
                >
                </a-entity>
            </a-entity>

            <!-- Third-person camera -->
            <a-entity
                id="camera-rig"
                third-person-camera="target: #player; distance: 6; height: 3; lookAtHeight: 1.75; damping: 0.4; enableCollision: true"
                position="0 5 -6"
                rotation="0 0 0"
            >
                <a-camera
                    id="camera"
                    look-controls="reverseMouseDrag: false; touchEnabled: true; pointerLockEnabled: true; magicWindowTrackingEnabled: false"
                    wasd-controls="enabled: false"
                    position="0 0 0"
                    rotation="-10 180 0"
                    near="0.1"
                    far="1000"
                >
                </a-camera>
            </a-entity>

            <!-- Debug visualization entities for camera (visible only in debug mode) -->
            <a-entity id="debugCamera" geometry="primitive: box; width: 0.5; height: 0.5; depth: 0.5" material="color: blue; opacity: 0.5" visible="false"></a-entity>
            <a-entity id="debugTarget" geometry="primitive: sphere; radius: 0.3" material="color: red; opacity: 0.5" visible="false"></a-entity>
            <a-entity id="debugLine" line="color: yellow; opacity: 0.5" visible="false"></a-entity>
            <a-entity id="debugText" text="value: Camera Debug; align: center; color: white" position="0 0 0" visible="false"></a-entity>
            <!-- Sky -->
            <a-sky color="#88CCEE"></a-sky>
            <!-- Lights -->
            <a-light type="ambient" color="#BBB" intensity="0.5"></a-light>
            <a-light
                type="directional"
                color="#FFF"
                intensity="1"
                position="-1 1 1"
            ></a-light>
        </a-scene>

        <script>
            document
                .getElementById("start-button")
                .addEventListener("click", function () {
                    document.getElementById("game-message").style.display =
                        "none";
                    document.body.requestPointerLock =
                        document.body.requestPointerLock ||
                        document.body.mozRequestPointerLock ||
                        document.body.webkitRequestPointerLock;
                    document.body.requestPointerLock();
                    const gameManager =
                        document.querySelector("[game-manager]").components[
                            "game-manager"
                        ];
                    if (gameManager && gameManager.startGame) {
                        gameManager.startGame();
                    }
                });

            document.addEventListener("pointerlockerror", function (event) {
                console.error("Pointer lock error:", event);
                const gameMessage = document.getElementById("game-message");
                gameMessage.style.display = "block";
                gameMessage.innerHTML =
                    'Error: Could not lock pointer. Please try again.<br><button id="retry-button">Retry</button>';
                document
                    .getElementById("retry-button")
                    .addEventListener("click", function () {
                        document.body.requestPointerLock();
                        gameMessage.style.display = "none";
                    });
            });

            document.addEventListener("pointerlockchange", function () {
                if (document.pointerLockElement === document.body) {
                    console.log("Pointer locked");
                    document.getElementById("camera-debug-controls").style.display = "none";
                } else {
                    console.log("Pointer unlocked");
                    // Show camera debug controls when game is paused
                    document.getElementById("camera-debug-controls").style.display = "block";
                    
                    const gameManager =
                        document.querySelector("[game-manager]");
                    const gameManagerComponent =
                        gameManager && gameManager.components
                            ? gameManager.components["game-manager"]
                            : null;

                    if (
                        gameManagerComponent &&
                        gameManagerComponent.gameStarted
                    ) {
                        const gameMessage =
                            document.getElementById("game-message");
                        gameMessage.style.display = "block";
                        gameMessage.innerHTML =
                            'Game Paused<br><button id="resume-button">Resume</button>';
                        document
                            .getElementById("resume-button")
                            .addEventListener(
                                "click",
                                function () {
                                    document.body.requestPointerLock();
                                    gameMessage.style.display = "none";
                                },
                                {
                                    once: true,
                                },
                            );
                    }
                }
            });
            
            // Camera debug controls
            document.addEventListener('DOMContentLoaded', function() {
                const cameraRig = document.getElementById('camera-rig');
                const cameraComponent = cameraRig ? cameraRig.components['third-person-camera'] : null;
                
                if (cameraComponent) {
                    // Set initial values
                    document.getElementById('camera-height-value').textContent = cameraComponent.data.height;
                    document.getElementById('camera-distance-value').textContent = cameraComponent.data.distance;
                    document.getElementById('camera-look-height-value').textContent = cameraComponent.data.lookAtHeight;
                    
                    // Height slider
                    document.getElementById('camera-height').addEventListener('input', function(e) {
                        const value = parseFloat(e.target.value);
                        cameraRig.setAttribute('third-person-camera', 'height', value);
                        document.getElementById('camera-height-value').textContent = value;
                        console.log('Camera height set to:', value);
                    });
                    
                    // Distance slider
                    document.getElementById('camera-distance').addEventListener('input', function(e) {
                        const value = parseFloat(e.target.value);
                        cameraRig.setAttribute('third-person-camera', 'distance', value);
                        document.getElementById('camera-distance-value').textContent = value;
                        console.log('Camera distance set to:', value);
                    });
                    
                    // Look height slider
                    document.getElementById('camera-look-height').addEventListener('input', function(e) {
                        const value = parseFloat(e.target.value);
                        cameraRig.setAttribute('third-person-camera', 'lookAtHeight', value);
                        document.getElementById('camera-look-height-value').textContent = value;
                        console.log('Look height set to:', value);
                    });
                    
                    // Toggle debug visualization
                    document.getElementById('toggle-debug-viz').addEventListener('click', function() {
                        if (cameraComponent.debugMode !== undefined) {
                            cameraComponent.debugMode = !cameraComponent.debugMode;
                            
                            // Update visibility of debug elements
                            if (cameraComponent.debugCamera) 
                                cameraComponent.debugCamera.setAttribute('visible', cameraComponent.debugMode);
                            if (cameraComponent.debugTarget) 
                                cameraComponent.debugTarget.setAttribute('visible', cameraComponent.debugMode);
                            if (cameraComponent.debugLine) 
                                cameraComponent.debugLine.setAttribute('visible', cameraComponent.debugMode);
                            if (cameraComponent.debugText) 
                                cameraComponent.debugText.setAttribute('visible', cameraComponent.debugMode);
                                
                            console.log('Debug visualization:', cameraComponent.debugMode ? 'ON' : 'OFF');
                        }
                    });
                    
                    // Keyboard shortcut for toggling debug controls
                    window.addEventListener('keydown', function(e) {
                        if (e.key === 'o' || e.key === 'O') {
                            const controls = document.getElementById('camera-debug-controls');
                            controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
                        }
                    });
                }
            });
        </script>
    </body>
</html>
